ssh.settings {
    dryRun = false
    logging = 'stdout'
    timeoutSec = 600000
    identity = file('${System.properties[\'user.home\']}/.ssh/id_rsa')
}

remotes {
    r1 {
        host = '192.168.1.20'
        user = 'db'
        rootFile = 'ROOT-sandbox.*.war'
        mobileFile = 'receipt-mobile-sandbox.*.war'
    }
    r2 {
        host = '192.168.1.22'
        user = 'db'
        rootFile = 'ROOT-sandbox.*.war'
        mobileFile = 'receipt-mobile-sandbox.*.war'
    }
    r3 {
        host = '192.168.1.21'
        user = 'db'
        rootFile = 'ROOT-sandbox.*.war'
        mobileFile = 'receipt-mobile-sandbox.*.war'
    }
    r4 {
        host = '192.168.1.23'
        user = 'db'
        rootFile = 'ROOT-loader-sandbox.*.war'
        mobileFile = 'receipt-mobile-sandbox.*.war'
    }
}

task deployServer << {
    deploy(remotes.r1)
}

deployServer.dependsOn war

def deploy(def server) {
    logger.lifecycle("Deploying to $server for $env")
    logger.lifecycle("Copying ${war.archivePath.absolutePath} to $server ... Be patient .. takes time ...")
    sshexec {
        session(server) {
            put(war.archivePath.absolutePath, war.archiveName)
        }
    }
    sshExecute(server, 'sudo service tomcat stop')
    sshExecute(server, 'sleep 20')
    sshExecute(server, 'rm -rf /usr/local/tomcat/webapps/*')
    put from: files(
            "/Users/Shared/Jenkins/Home/jobs/receiptofi-sandbox-build/workspace/build/war/sandbox/$server.rootFile",
            "/Users/Shared/Jenkins/Home/jobs/receiptofi.mobile-sandbox-build/workspace/build/war/sandbox/$server.mobileFile"
    ), into: "/usr/local/tomcat/webapps/"
    sshExecute(server,  "cd /usr/local/tomcat/webapps/; mv $server.rootFile ROOT.war")
    sshExecute(server,  "cd /usr/local/tomcat/webapps/; mv $server.mobileFile receipt-mobile.war")

    sshExecute(server, 'sudo service tomcat start')
    sshExecute(server, 'sudo service tomcat status')
}

def sshExecute(def server, def cmd) {
    logger.lifecycle("Executing '$cmd'  ...")
    sshexec {
        session(server) {
            execute(cmd, pty: false)
        }
    }
}